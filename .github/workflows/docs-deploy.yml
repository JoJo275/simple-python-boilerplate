# ──────────────────────────────────────────────────────────────
# Docs Deploy Workflow
# ──────────────────────────────────────────────────────────────
# Builds the MkDocs documentation site and deploys it to
# GitHub Pages. Uses --strict mode so warnings (broken links,
# missing references) fail the build.
#
# Triggers:
#   - Push to main (deploys latest docs)
#   - Pull requests targeting main (build-only, no deploy)
#   - Manual dispatch via the GitHub Actions UI
#
# Prerequisites:
#   In Settings → Pages → "Build and deployment":
#     Source = "GitHub Actions" (NOT "Deploy from a branch")
#
# TODO (template users):
#   1. Enable the repository guard (pick ONE):
#        Option A – Replace 'YOURNAME/YOURTEMPLATE' below with
#                   your actual repo slug (e.g. 'myorg/myproject').
#        Option B – Set a repository variable (no YAML edits needed):
#                     vars.ENABLE_DOCS_DEPLOY = 'true'
#                   (Settings → Secrets and variables → Actions → Variables)
#   2. In repo Settings → Pages, set Source to "GitHub Actions".
#   3. Uncomment site_url in mkdocs.yml and set it to your
#      GitHub Pages URL (e.g. https://myorg.github.io/myproject/).
# ──────────────────────────────────────────────────────────────

name: Docs

on:
  push:
    branches: [main]
    paths:
      - "docs/**"
      - "mkdocs.yml"
      - "src/**/*.py"
      - "pyproject.toml"
      - ".github/workflows/docs-deploy.yml"
  pull_request:
    branches: [main]
    paths:
      - "docs/**"
      - "mkdocs.yml"
      - "src/**/*.py"
      - "pyproject.toml"
      - ".github/workflows/docs-deploy.yml"
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages.
permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ── Job 1: Build ───────────────────────────────────────────
  build:
    name: Build docs

    # ── Repository guard ──────────────────────────────────────
    # Prevents this workflow from running on forks or clones
    # that haven't opted in.
    #
    #   Option A  – Edit the hardcoded slug below.
    #   Option B  – Set vars.ENABLE_DOCS_DEPLOY = 'true'.
    if: >-
      ${{
        github.repository == 'YOURNAME/YOURTEMPLATE'
        || vars.ENABLE_DOCS_DEPLOY == 'true'
      }}
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0               # Full history for mkdocstrings source links
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: python -m pip install --upgrade pip ".[docs]"

      - name: Build docs (strict)
        run: mkdocs build --strict

      - name: Configure GitHub Pages
        if: github.event_name != 'pull_request'
        uses: actions/configure-pages@983d7736d9b0ae728b81ab479565c72886d7745b # v5.0.0

      - name: Upload Pages artifact
        if: github.event_name != 'pull_request'
        uses: actions/upload-pages-artifact@7b1f4a764d45c48632c6b24a0339c27f5614fb0b # v4.0.0
        with:
          path: site/

  # ── Job 2: Deploy ──────────────────────────────────────────
  # Only runs on push to main (not on PRs).
  deploy:
    name: Deploy to GitHub Pages
    if: github.event_name != 'pull_request'
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 5

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e # v4.0.5
