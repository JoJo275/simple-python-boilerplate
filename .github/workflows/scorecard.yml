# ──────────────────────────────────────────────────────────────
# OpenSSF Scorecard Workflow
# ──────────────────────────────────────────────────────────────
# Runs the OpenSSF Scorecard against the repository to evaluate
# security practices: branch protection, dependency pinning,
# signed releases, CI/CD hardening, etc.
#
# Results are uploaded to the Security tab (code scanning alerts)
# and to the OpenSSF REST API for public badge generation.
#
# Triggers:
#   - Push to main (re-evaluate on every merge)
#   - Weekly schedule (catch configuration drift)
#   - Manual dispatch via the GitHub Actions UI
#
# TODO (template users):
#   1. Enable the repository guard (pick ONE):
#        Option A – Replace 'YOURNAME/YOURTEMPLATE' below with
#                   your actual repo slug (e.g. 'myorg/myproject').
#        Option B – Set a repository variable (no YAML edits needed):
#                     vars.ENABLE_SCORECARD = 'true'
#                   (Settings → Secrets and variables → Actions → Variables)
#   2. (Optional) Add a Scorecard badge to your README:
#      https://securityscorecards.dev/#/
# ──────────────────────────────────────────────────────────────

name: OpenSSF Scorecard

on:
  push:
    branches: [main]
  schedule:
    # Cron is a Unix time-scheduling syntax and the only way to
    # define scheduled triggers in GitHub Actions. It uses five
    # fields (all in UTC):
    #
    #   ┌─── minute (0–59)
    #   │ ┌─── hour (0–23)
    #   │ │ ┌─── day of month (1–31)
    #   │ │ │ ┌─── month (1–12)
    #   │ │ │ │ ┌─── day of week (0=Sun … 6=Sat)
    #   │ │ │ │ │
    #   * * * * *
    #
    # Because cron is fixed to UTC, local time shifts with DST (Daylight Saving Time):
    #   09:00 UTC = 04:00 EST (Nov–Mar) / 05:00 EDT (Mar–Nov)
    - cron: "0 9 * * 1"  # Every Monday at 09:00 UTC
  workflow_dispatch:

# Scorecard needs these permissions to read repo metadata and
# upload results to the Security tab via SARIF.
permissions:
  contents: read
  security-events: write
  id-token: write          # Needed for publishing results to OpenSSF

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  scorecard:
    name: Scorecard analysis

    # ── Repository guard ──────────────────────────────────────
    # Prevents this workflow from running on forks or clones
    # that haven't opted in.
    #
    #   Option A  – Edit the hardcoded slug below.
    #   Option B  – Set vars.ENABLE_SCORECARD = 'true'.
    if: >-
      ${{
        github.repository == 'YOURNAME/YOURTEMPLATE'
        || vars.ENABLE_WORKFLOWS == 'true'
        || vars.ENABLE_SCORECARD == 'true'
      }}
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Run Scorecard
        uses: ossf/scorecard-action@05b42c624433fc40578a4040d5cf40ec07d397f0 # v2.4.2
        with:
          results_file: results.sarif
          results_format: sarif
          # Publish results to OpenSSF REST API for badge.
          # Set to false if you don't want public visibility.
          publish_results: true

      # Upload SARIF to GitHub Security tab → Code scanning alerts
      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@9e907b5e64f6b83e7804b09294d44122997950d6 # v4.32.3
        with:
          sarif_file: results.sarif
