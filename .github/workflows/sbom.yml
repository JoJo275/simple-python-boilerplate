# ──────────────────────────────────────────────────────────────
# SBOM (Software Bill of Materials) Workflow
# ──────────────────────────────────────────────────────────────
# Generates SBOMs in two standard formats and optionally
# submits dependency data to GitHub's Dependency Graph.
#
# Outputs per workflow run:
#   • sbom-spdx artifact       — SPDX 2.3 JSON (primary format)
#   • sbom-cyclonedx artifact  — CycloneDX 1.x JSON (secondary)
#   • Dependency Graph update  — push to main only (channel 4)
#
# This is channel 2 ("Actions artifact") of the four SBOM
# distribution channels documented in docs/sbom.md.
#
# For release-asset SBOMs (channel 3), see release.yml.
# Release-asset SBOMs are authoritative for tagged versions.
#
# Triggers:
#   - Push to main
#   - Pull requests targeting main
#   - Weekly schedule (Monday 13:00 UTC; 9am ET during DST)
#   - Manual dispatch
#
# TODO (template users):
#   1. Enable the repository guard (pick ONE):
#        Option A – Replace 'YOURNAME/YOURTEMPLATE' below with
#                   your actual repo slug (e.g. 'myorg/myproject').
#        Option B – Set a repository variable (no YAML edits needed):
#                     vars.ENABLE_SBOM = 'true'
#                   (Settings → Secrets and variables → Actions → Variables)
# ──────────────────────────────────────────────────────────────

name: SBOM

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Cron is a Unix time-scheduling syntax and the only way to
    # define scheduled triggers in GitHub Actions. It uses five
    # fields (all in UTC):
    #
    #   ┌─── minute (0–59)
    #   │ ┌─── hour (0–23)
    #   │ │ ┌─── day of month (1–31)
    #   │ │ │ ┌─── month (1–12)
    #   │ │ │ │ ┌─── day of week (0=Sun … 6=Sat)
    #   │ │ │ │ │
    #   * * * * *
    #
    # Because cron is fixed to UTC, local time shifts with DST (Daylight Saving Time):
    #   13:00 UTC = 08:00 EST (Nov–Mar) / 09:00 EDT (Mar–Nov)
    - cron: "0 13 * * 1" # Monday 13:00 UTC
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ── Generate SBOMs ─────────────────────────────────────────
  # Uses Syft (via anchore/sbom-action) to scan the installed
  # Python environment and produce both SPDX and CycloneDX
  # SBOMs. Each is uploaded as a separate workflow artifact.
  #
  # On push to main, the SPDX scan also submits dependency
  # data to GitHub's Dependency Submission API so the repo's
  # dependency graph and Dependabot alerts are more complete.
  generate:
    name: Generate SBOMs

    # ── Repository guard ──────────────────────────────────────
    if: >-
      ${{
        github.repository == 'YOURNAME/YOURTEMPLATE'
        || vars.ENABLE_WORKFLOWS == 'true'
        || vars.ENABLE_SBOM == 'true'
      }}
    runs-on: ubuntu-latest
    timeout-minutes: 10

    # contents: write is needed for Dependency Submission API
    # (only exercised on push to main via the conditional below).
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # Checkout a Git repository at a particular version (v6.0.2)
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # Set up a specific version of Python and add… (v6.2.0)
        with:
          python-version: "3.12"
          cache: "pip"

      # Install the project so Syft can detect the full
      # dependency tree from the Python environment.
      - name: Install project
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .

      # ── SPDX (primary format) ──────────────────────────────
      # Generates an SPDX 2.3 JSON SBOM. On push to main the
      # dependency-snapshot flag also submits dependency data
      # to GitHub's Dependency Submission API (channel 4).
      - name: Generate SPDX SBOM (primary)
        uses: anchore/sbom-action@28d71544de8eaf1b958d335707167c5f783590ad # Creates an SBOM (Software Bill Of Materials)… (v0.22.2)
        with:
          format: spdx-json
          output-file: sbom-spdx.json
          artifact-name: sbom-spdx
          dependency-snapshot: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}

      # ── CycloneDX (secondary format) ───────────────────────
      # Generates a CycloneDX 1.x JSON SBOM for consumers
      # that prefer the CycloneDX standard.
      - name: Generate CycloneDX SBOM
        uses: anchore/sbom-action@28d71544de8eaf1b958d335707167c5f783590ad # Creates an SBOM (Software Bill Of Materials)… (v0.22.2)
        with:
          format: cyclonedx-json
          output-file: sbom-cyclonedx.json
          artifact-name: sbom-cyclonedx
