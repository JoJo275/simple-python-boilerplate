# ──────────────────────────────────────────────────────────────
# Security Audit Workflow (pip-audit)
# ──────────────────────────────────────────────────────────────
# Checks installed Python dependencies against the OSV and
# PyPI vulnerability databases using pip-audit.
#
# Triggers:
#   - Push to main
#   - Pull requests targeting main
#   - Weekly schedule (Monday 13:00 UTC; 9am ET during DST / 8am ET otherwise)
#   - Manual dispatch
#
# TODO (template users):
#   1. Enable the repository guard (pick ONE):
#        Option A – Replace 'YOURNAME/YOURTEMPLATE' below with
#                   your actual repo slug (e.g. 'myorg/myproject').
#        Option B – Set a repository variable (no YAML edits needed):
#                     vars.ENABLE_SECURITY_AUDIT = 'true'
#                   (Settings → Secrets and variables → Actions → Variables)
# ──────────────────────────────────────────────────────────────

name: Security Audit

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Cron is a Unix time-scheduling syntax and the only way to
    # define scheduled triggers in GitHub Actions. It uses five
    # fields (all in UTC):
    #
    #   ┌─── minute (0–59)
    #   │ ┌─── hour (0–23)
    #   │ │ ┌─── day of month (1–31)
    #   │ │ │ ┌─── month (1–12)
    #   │ │ │ │ ┌─── day of week (0=Sun … 6=Sat)
    #   │ │ │ │ │
    #   * * * * *
    #
    # Because cron is fixed to UTC, local time shifts with DST.
    - cron: "0 13 * * 1" # Monday 13:00 UTC (9am ET during DST / 8am ET otherwise)
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  pip-audit:
    name: pip-audit

    # ── Repository guard ──────────────────────────────────────
    # Prevents this workflow from running on forks or clones
    # that haven't opted in.
    if: >-
      ${{
        github.repository == 'YOURNAME/YOURTEMPLATE'
        || vars.ENABLE_SECURITY_AUDIT == 'true'
      }}
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .

      - name: Run pip-audit
        uses: pypa/gh-action-pip-audit@1220774d901786e6f652ae159f7b6bc8fea6d266 # v1.1.0
        with:
          # Audit the current environment (installed packages)
          # Use --desc to include vulnerability descriptions
          inputs: ""
          # Uncomment to ignore specific vulnerabilities by ID:
          # ignore-vulns: |
          #   GHSA-xxxx-xxxx-xxxx
          #   PYSEC-2024-xxxx
