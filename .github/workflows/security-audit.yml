# ──────────────────────────────────────────────────────────────
# Security Audit Workflow (pip-audit)
# ──────────────────────────────────────────────────────────────
# Checks installed Python dependencies against the OSV and
# PyPI vulnerability databases using pip-audit.
#
# Triggers:
#   - Push to main
#   - Pull requests targeting main
#   - Weekly schedule (Monday 9am ET)
#   - Manual dispatch
#
# TODO (template users):
#   1. Enable the repository guard (pick ONE):
#        Option A – Replace 'YOURNAME/YOURTEMPLATE' below with
#                   your actual repo slug (e.g. 'myorg/myproject').
#        Option B – Set two repository-level variables (no YAML
#                   edits needed):
#                     vars.CANONICAL_REPO = 'myorg/myproject'
#                     vars.ENABLE_SECURITY_AUDIT = 'true'
#                   (Settings → Secrets and variables → Actions → Variables)
# ──────────────────────────────────────────────────────────────

name: Security Audit

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 13 * * 1" # Monday 9am ET (13:00 UTC)
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  pip-audit:
    name: pip-audit

    # ── Repository guard ──────────────────────────────────────
    # Prevents this workflow from running on forks or clones
    # that haven't opted in.
    if: >-
      ${{
        github.repository == 'YOURNAME/YOURTEMPLATE'
        || (
          github.repository == vars.CANONICAL_REPO
          && vars.ENABLE_SECURITY_AUDIT == 'true'
        )
      }}
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .

      - name: Run pip-audit
        uses: pypa/gh-action-pip-audit@1220774d901786e6f652ae159f7b6bc8fea6d266 # v1.1.0
        with:
          # Audit the current environment (installed packages)
          # Use --desc to include vulnerability descriptions
          inputs: ""
          # Uncomment to ignore specific vulnerabilities by ID:
          # ignore-vulns: |
          #   GHSA-xxxx-xxxx-xxxx
          #   PYSEC-2024-xxxx
