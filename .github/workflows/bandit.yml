# ──────────────────────────────────────────────────────────────
# Bandit Workflow (static security analysis)
# ──────────────────────────────────────────────────────────────
# Scans Python source code for common security issues such as
# hardcoded passwords, SQL injection, use of unsafe functions,
# and insecure subprocess calls.
#
# Triggers:
#   - Push to main (catch issues as they land)
#   - Pull requests targeting main
#   - Nightly schedule (03:00 UTC; 11pm ET during DST / 10pm ET otherwise)
#   - Manual dispatch
#
# TODO (template users):
#   1. Enable the repository guard (pick ONE):
#        Option A – Replace 'YOURNAME/YOURTEMPLATE' below with
#                   your actual repo slug (e.g. 'myorg/myproject').
#        Option B – Set a repository variable (no YAML edits needed):
#                     vars.ENABLE_BANDIT == 'true'
#                   (Settings → Secrets and variables → Actions → Variables)
# ──────────────────────────────────────────────────────────────

name: Bandit

on:
  push:
    branches: [main]
    paths:
      - "src/**"
      - "scripts/**"
      - "experiments/**"
      - "pyproject.toml"
  pull_request:
    branches: [main]
    paths:
      - "src/**"
      - "scripts/**"
      - "experiments/**"
      - "pyproject.toml"
  schedule:
    # Cron is a Unix time-scheduling syntax and the only way to
    # define scheduled triggers in GitHub Actions. It uses five
    # fields (all in UTC):
    #
    #   ┌─── minute (0–59)
    #   │ ┌─── hour (0–23)
    #   │ │ ┌─── day of month (1–31)
    #   │ │ │ ┌─── month (1–12)
    #   │ │ │ │ ┌─── day of week (0=Sun … 6=Sat)
    #   │ │ │ │ │
    #   * * * * *
    #
    # Because cron is fixed to UTC, local time shifts with DST (Daylight Saving Time):
    #   03:00 UTC = 22:00 EST (Nov–Mar) / 23:00 EDT (Mar–Nov)
    - cron: "0 3 * * *" # Daily 03:00 UTC
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  bandit:
    name: Bandit security scan

    # ── Repository guard ──────────────────────────────────────
    # Prevents this workflow from running on forks or clones
    # that haven't opted in.
    if: >-
      ${{
        github.repository == 'YOURNAME/YOURTEMPLATE'
        || vars.ENABLE_WORKFLOWS == 'true'
        || vars.ENABLE_BANDIT == 'true'
      }}
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # Checkout a Git repository at a particular version (v6.0.2)
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # Set up a specific version of Python and add… (v6.2.0)
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install bandit
        run: python -m pip install bandit[toml]

      - name: Run bandit
        run: bandit -r src/ scripts/ experiments/ -c pyproject.toml
