# Architecture

## Overview

<!-- TODO (template users): Replace this overview with your application's
     purpose, key responsibilities, and high-level design philosophy. -->

A Python CLI application using `src/` layout ([ADR 001](../adr/001-src-layout.md)),
built with Hatchling ([ADR 016](../adr/016-hatchling-and-hatch.md)), and
managed with Hatch for environments and task execution. All tool configuration
lives in `pyproject.toml` ([ADR 002](../adr/002-pyproject-toml.md)).

The project follows a layered architecture with clear separation between
entry points, CLI parsing, core logic, and (future) API/data layers.

## High-Level Architecture

<!-- TODO (template users): Update this diagram to reflect your actual
     architecture — add/remove layers, services, databases, or external
     integrations as needed. -->

```
┌──────────────────────────────────────────────────────────────┐
│                       Application                            │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌────────────┐   ┌────────────┐   ┌──────────────┐          │
│  │  main.py   │──▶│   cli.py  │──▶│  engine.py   │          │
│  │  (entry    │   │  (argparse │   │  (core logic │          │
│  │   points)  │   │   parsing) │   │   TypedDicts)│          │
│  └────────────┘   └────────────┘   └──────┬───────┘          │
│                                           │                  │
│  ┌────────────┐                    ┌──────▼───────┐          │
│  │   api.py   │ (placeholder)      │  sql/        │          │
│  │  (HTTP/    │                    │  (embedded   │          │
│  │   REST)    │                    │   queries)   │          │
│  └────────────┘                    └──────┬───────┘          │
│                                           │                  │
│                                    ┌──────▼───────┐          │
│                                    │   Database   │          │
│                                    │   (SQLite)   │          │
│                                    └──────────────┘          │
│                                                              │
│  ┌────────────────────┐                                      │
│  │  dev_tools/        │  (repo maintenance, not app logic)   │
│  │  (empty scaffold)  │                                      │
│  └────────────────────┘                                      │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

## Module Responsibilities

```
main.py   → starts the program (entry points, thin wrappers)
cli.py    → defines CLI contract (argument parsing, commands)
engine.py → defines behavior (core logic, interface-agnostic)
api.py    → defines callable interface (HTTP/REST, placeholder)
```

The key design principle: `engine.py` has **no knowledge** of how it's
invoked. CLI, API, tests, or scripts can all call into it directly.

## Directory Structure

<!-- TODO (template users): Update to reflect your actual package structure
     after renaming and adding modules. -->

```
src/simple_python_boilerplate/
├── __init__.py          # Package root, version re-export
├── _version.py          # Auto-generated by hatch-vcs (gitignored)
├── py.typed             # PEP 561 typed package marker
├── main.py              # CLI entry points (thin wrappers)
├── cli.py               # Argument parsing, command dispatch
├── engine.py            # Core logic, TypedDict models, diagnostics
├── api.py               # HTTP/REST interface (placeholder)
├── sql/                 # Embedded SQL queries
│   ├── __init__.py
│   └── example_query.sql
└── dev_tools/           # Repo maintenance utilities
    └── __init__.py

scripts/                 # Standalone scripts (not part of package)
├── apply_labels.py      # GitHub label management
├── apply-labels.sh      # Shell wrapper for label script
├── archive_todos.py     # Archive completed TODO items
├── bootstrap.py         # One-command setup for fresh clones
├── changelog_check.py   # Verify CHANGELOG matches git tags
├── check_todos.py       # Scan for TODO (template users) comments
├── clean.py             # Remove build artifacts and caches
├── customize.py         # Interactive project customization
├── dep_versions.py      # Dependency version reporting
├── doctor.py            # Diagnostics bundle for bug reports
├── env_doctor.py        # Environment health check
├── repo_doctor.py       # Repository health checks
├── workflow_versions.py # SHA-pinned action version reporting
├── precommit/           # Custom pre-commit hooks
│   └── check_nul_bytes.py
└── sql/                 # SQL utilities
    ├── reset.sql
    └── scratch.example.sql

db/                      # Database files (not embedded in package)
├── schema.sql           # Current schema definition
├── migrations/          # Incremental schema changes
├── seeds/               # Initial data
└── queries/             # Standalone SQL queries

tests/
├── conftest.py          # Shared fixtures
├── unit/                # Unit tests
└── integration/         # Integration tests

docs/
├── adr/                 # Architecture Decision Records
├── design/              # Architecture, tool decisions
├── development/         # Developer guides
├── guide/               # User-facing guides
├── notes/               # Internal notes, resources
├── reference/           # Reference documentation
├── templates/           # Document templates
└── *.md                 # Workflow, release, and reference docs
```

## Entry Points

<!-- TODO (template users): Update with your actual CLI commands. -->

Configured in `pyproject.toml` under `[project.scripts]`:

| Command | Function | Description |
|---------|----------|-------------|
| `spb` | `main:main` | Primary CLI — parses args via `cli.py`, dispatches to `engine.py` |
| `spb-version` | `main:print_version` | Print package + Python version |
| `spb-doctor` | `main:doctor` | Diagnose environment (venv, tools, config files) |

## Data Flow

<!-- TODO (template users): Document your actual data flows. -->

### CLI command

```
User runs `spb process <input>`
  → main.main()
    → cli.parse_args()         # argparse
    → cli.run(args)
      → engine.validate_input()
      → engine.process_data()
    → sys.exit(return_code)
```

### Doctor command

```
User runs `spb-doctor`
  → main.doctor()
    → engine.get_version_info()    # VersionInfo TypedDict
    → engine.diagnose_environment() # DiagnosticInfo TypedDict
    → print diagnostic report
```

## Key Data Structures

`engine.py` uses `TypedDict` for structured return types:

- **`VersionInfo`** — package version, Python version, platform
- **`DiagnosticInfo`** — version info, executable path, venv status,
  tool availability, config file presence

## Versioning

Version is derived from git tags at build time via `hatch-vcs`
([ADR 016](../adr/016-hatchling-and-hatch.md)):

1. `hatch-vcs` reads the latest git tag (e.g. `v1.2.3`)
2. Generates `_version.py` with `__version__` and `__version_tuple__`
3. `__init__.py` re-exports the version, with a hardcoded fallback
   that `release-please` keeps in sync via `# x-release-please-version`
4. `release-please` creates the git tags automatically
   ([ADR 021](../adr/021-automated-release-pipeline.md))

## CI/CD Architecture

29 workflow files in `.github/workflows/`, all SHA-pinned
([ADR 004](../adr/004-pin-action-shas.md)) with repository guard pattern
([ADR 011](../adr/011-repository-guard-pattern.md)).

```
PR opened / push to main
  ├── lint-format.yml       (Ruff lint + format)
  ├── type-check.yml        (mypy strict)
  ├── test.yml              (pytest × 3.11, 3.12, 3.13)
  ├── coverage.yml          (pytest-cov → Codecov)
  ├── spellcheck.yml        (codespell)
  ├── spellcheck-autofix.yml (auto-fix spelling in PRs)
  ├── security-audit.yml    (pip-audit)
  ├── dependency-review.yml (license + vuln check)
  ├── commit-lint.yml       (Conventional Commits)
  ├── pr-title.yml          (PR title format)
  ├── labeler.yml           (auto-label PRs by path)
  ├── bandit.yml            (path-filtered: src/, scripts/)
  ├── link-checker.yml      (path-filtered: *.md, docs/)
  ├── container-build.yml   (OCI image build)
  ├── container-scan.yml    (Trivy scan)
  ├── docs-build.yml        (MkDocs build — CI gate check)
  ├── docs-deploy.yml       (GitHub Pages deployment, path-filtered)
  └── ci-gate.yml           (fan-in: single "gate" required check)
                           └── polls Checks API for all required jobs
                           └── only check listed in branch protection

push to main (release-please)
  └── release-please.yml → creates Release PR → git tag → GitHub Release
      ├── release.yml    → build sdist/wheel → publish
      └── sbom.yml       → generate SBOM

scheduled / maintenance
  ├── nightly-security.yml    (comprehensive scan)
  ├── security-codeql.yml     (CodeQL analysis)
  ├── scorecard.yml           (OpenSSF Scorecard)
  ├── pre-commit-update.yml   (weekly hook updates)
  ├── stale.yml               (close stale issues/PRs)
  ├── cache-cleanup.yml       (GH Actions cache pruning)
  ├── regenerate-files.yml    (rebuild generated artifacts)
  └── auto-merge-dependabot.yml (auto-merge minor/patch updates)
```

See [ADR 024](../adr/024-ci-gate-pattern.md) for why only the `gate` check
is required in branch protection.

## Design Decisions

Key architectural decisions are documented in [ADRs](../adr/):

| ADR | Decision |
|-----|----------|
| [001](../adr/001-src-layout.md) | src/ layout for packages |
| [002](../adr/002-pyproject-toml.md) | pyproject.toml as single source of truth |
| [003](../adr/003-separate-workflow-files.md) | Separate workflow files per concern |
| [004](../adr/004-pin-action-shas.md) | SHA-pinned GitHub Actions |
| [005](../adr/005-ruff-for-linting-formatting.md) | Ruff for linting + formatting |
| [006](../adr/006-pytest-for-testing.md) | pytest for testing |
| [007](../adr/007-mypy-for-type-checking.md) | mypy for type checking (strict) |
| [008](../adr/008-pre-commit-hooks.md) | Pre-commit hooks (43 across 4 stages) |
| [009](../adr/009-conventional-commits.md) | Conventional Commits |
| [011](../adr/011-repository-guard-pattern.md) | Repository guard pattern |
| [012](../adr/012-multi-layer-security-scanning.md) | Multi-layer security scanning |
| [016](../adr/016-hatchling-and-hatch.md) | Hatchling + Hatch |
| [020](../adr/020-mkdocs-documentation-stack.md) | MkDocs Material documentation stack |
| [021](../adr/021-automated-release-pipeline.md) | Automated release pipeline |
| [024](../adr/024-ci-gate-pattern.md) | CI gate pattern |
| [025](../adr/025-container-strategy.md) | Container strategy |
| [029](../adr/029-testing-strategy.md) | Testing strategy |
| [031](../adr/031-script-conventions.md) | Script conventions |
| [032](../adr/032-dependency-grouping-strategy.md) | Dependency grouping strategy |

Tool-level trade-off notes live in [tool-decisions.md](tool-decisions.md).

## External Dependencies

<!-- TODO (template users): List your runtime dependencies here. -->

| Dependency | Purpose | Source |
|------------|---------|--------|
| Python stdlib only | Runtime (no third-party runtime deps) | `pyproject.toml` `[project.dependencies]` |
| sqlite3 | Database (stdlib) | — |
| argparse | CLI parsing (stdlib) | — |

Dev/test dependencies are listed in `pyproject.toml`
`[project.optional-dependencies]` and consumed by Hatch environments.

## What's Not Yet Implemented

- **`api.py`** — HTTP/REST interface is a placeholder (`NotImplementedError`)
- **`dev_tools/`** — Empty package (just `__init__.py`), intended for repo maintenance utilities
- **`sql/`** — Has `example_query.sql` only, no application queries yet
- **`db/schema.sql`** — Placeholder schema, no tables defined


## Related Documentation

- [Tool Decisions](tool-decisions.md) — Detailed tool comparison notes
- [Database Design](database.md) — Schema and data model
- [ADRs](../adr/) — Architecture Decision Records
- [Development Guide](../development/) — Developer setup
